{% extends "base.html" %}

{% block title %}{{ episodio.Titolo }}{% endblock %}

{% block content %}
<div class="py-4">
    <!-- Episode Header -->
    <div class="text-center mb-4" data-aos="fade-up">
        <h2 class="text-gradient" style="font-weight: 800;">{{ episodio.Titolo }}</h2>
        <p class="episode-date mt-2"><i class="bi bi-calendar3"></i> {{ episodio.DataCreazione }}</p>
    </div>

    <!-- Episode Description & Actions -->
    <div class="row justify-content-center" data-aos="fade-up" data-aos-delay="100">
        <div class="col-lg-8">
            <p style="color: var(--text-secondary); text-align: center; font-size: 1.05rem;">{{ episodio.Descrizione }}</p>

            {% if isactive and user.Tipo == 1 and podcast.utente_id == user.ID %}
            <div class="text-center mt-3 mb-3">
                <a href="{{ url_for('modificaEpisodio', titolo=episodio.Titolo) }}" class="btn btn-glass me-2">
                    <i class="bi bi-pencil"></i> Modifica
                </a>
                <a href="{{ url_for('cancellaEpisodio', titolo=episodio.Titolo) }}" class="btn btn-glass" style="border-color: #ef4444; color: #ef4444;">
                    <i class="bi bi-trash"></i> Elimina
                </a>
            </div>
            {% elif not isactive %}
            <div class="text-center mt-3 mb-3">
                <a href="{{ url_for('login') }}" class="btn btn-gradient">
                    <i class="bi bi-box-arrow-in-right"></i> Accedi per più funzionalità
                </a>
            </div>
            {% endif %}

            <!-- Audio Player -->
            <div class="audio-player-wrapper" data-aos="fade-up" data-aos-delay="200" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));">
                <audio src="{{ url_for('static', filename='episodio' + episodio.episodio_id|string + 'podcast' + episodio.podcast_id|string + episodio.Estensione) }}" controls></audio>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="row justify-content-center mt-5">
        <div class="col-lg-8">
            <h5 class="section-heading" data-aos="fade-up"><i class="bi bi-chat-dots"></i> Commenti</h5>

            {% if isactive %}
            <!-- New Comment Form -->
            <div class="comment-card mb-4" data-aos="fade-up">
                <form action="/nuovoCommento" method="POST" enctype="multipart/form-data">
                    <div class="d-flex gap-3 align-items-start">
                        <div class="comment-avatar">{{ user.Username[0]|upper }}</div>
                        <div class="flex-grow-1">
                            <input class="form-control" type="text" placeholder="Scrivi un commento..." name="testo_commento"
                                   style="background: var(--bg-elevated); border-color: var(--border-glass); color: var(--text-primary);">
                            <input type="hidden" name="episodio_id" value="{{ episodio.episodio_id }}">
                            <input type="hidden" name="podcast_id" value="{{ episodio.podcast_id }}">
                        </div>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Past Comments -->
            {% if commenti %}
                {% for commento in commenti %}
                <div class="comment-card" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 60 }}">
                    <div class="d-flex gap-3">
                        <div class="comment-avatar">{{ commento.Username[0]|upper }}</div>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="comment-username">{{ commento.Username }}</span>
                                {% if isactive and commento.utente_id == user.ID %}
                                <div class="dropdown">
                                    <button class="btn btn-glass btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" style="padding: 0.15rem 0.5rem; font-size: 0.75rem;">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('modificaCommento', commento_id=commento.commento_id) }}"><i class="bi bi-pencil"></i> Modifica</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('cancellaCommento', commento_id=commento.commento_id) }}" style="color: #ef4444;"><i class="bi bi-trash"></i> Cancella</a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                            <p class="comment-text">{{ commento.Testo }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-3" data-aos="fade-up">
                    <p style="color: var(--text-muted);"><i class="bi bi-chat"></i> Nessun commento ancora. Sii il primo!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
